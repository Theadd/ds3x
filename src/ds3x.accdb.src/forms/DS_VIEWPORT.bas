Version =20
VersionRequired =20
Begin Form
    PopUp = NotDefault
    RecordSelectors = NotDefault
    FastLaserPrinting = NotDefault
    AutoCenter = NotDefault
    NavigationButtons = NotDefault
    DividingLines = NotDefault
    KeyPreview = NotDefault
    DataEntry = NotDefault
    AllowDesignChanges = NotDefault
    DefaultView =0
    ScrollBars =0
    ViewsAllowed =1
    TabularCharSet =177
    TabularFamily =0
    PictureAlignment =2
    DatasheetGridlinesBehavior =3
    GridY =10
    Width =3436
    DatasheetFontHeight =11
    ItemSuffix =1559
    Left =4065
    Top =3030
    Right =28545
    Bottom =15225
    OnUnload ="[Event Procedure]"
    RecSrcDt = Begin
        0x4a0577b4d2d8e540
    End
    Caption ="dsLiveEd - TEST"
    DatasheetFontName ="Calibri"
    AllowDatasheetView =0
    FilterOnLoad =0
    SplitFormDatasheet =1
    SplitFormDatasheet =1
    ShowPageMargins =0
    DisplayOnSharePointSite =1
    DatasheetAlternateBackColor =15921906
    DatasheetGridlinesColor12 =0
    FitToScreen =255
    DatasheetBackThemeColorIndex =1
    BorderThemeColorIndex =3
    ThemeFontIndex =1
    ForeThemeColorIndex =0
    AlternateBackThemeColorIndex =1
    AlternateBackShade =95.0
    Begin
        Begin Label
            BackStyle =0
            FontSize =11
            FontName ="Calibri"
            ThemeFontIndex =1
            BackThemeColorIndex =1
            BorderThemeColorIndex =0
            BorderTint =50.0
            ForeThemeColorIndex =0
            ForeTint =50.0
            GridlineThemeColorIndex =1
            GridlineShade =65.0
        End
        Begin Rectangle
            SpecialEffect =3
            BackStyle =0
            BorderLineStyle =0
            Width =850
            Height =850
            BorderShade =65.0
            GridlineShade =65.0
        End
        Begin CommandButton
            Width =1701
            Height =283
            FontSize =11
            FontWeight =400
            FontName ="Calibri"
            ForeThemeColorIndex =0
            ForeTint =75.0
            GridlineThemeColorIndex =1
            GridlineShade =65.0
            UseTheme =1
            Shape =1
            Gradient =12
            BackThemeColorIndex =4
            BackTint =60.0
            BorderLineStyle =0
            BorderThemeColorIndex =4
            BorderTint =60.0
            ThemeFontIndex =1
            HoverThemeColorIndex =4
            HoverTint =40.0
            PressedThemeColorIndex =4
            PressedShade =75.0
            HoverForeThemeColorIndex =0
            HoverForeTint =75.0
            PressedForeThemeColorIndex =0
            PressedForeTint =75.0
        End
        Begin OptionButton
            BorderLineStyle =0
            LabelX =230
            LabelY =-30
            BorderThemeColorIndex =1
            BorderShade =65.0
            GridlineThemeColorIndex =1
            GridlineShade =65.0
        End
        Begin CheckBox
            BorderLineStyle =0
            LabelX =230
            LabelY =-30
            BorderThemeColorIndex =1
            BorderShade =65.0
            GridlineThemeColorIndex =1
            GridlineShade =65.0
        End
        Begin OptionGroup
            SpecialEffect =3
            BorderLineStyle =0
            Width =1701
            Height =1701
            BackThemeColorIndex =1
            BorderThemeColorIndex =1
            BorderShade =65.0
            GridlineThemeColorIndex =1
            GridlineShade =65.0
        End
        Begin BoundObjectFrame
            AddColon = NotDefault
            SizeMode =3
            SpecialEffect =2
            BorderLineStyle =0
            Width =4536
            Height =2835
            LabelX =-1701
            BackThemeColorIndex =1
            BorderThemeColorIndex =1
            BorderShade =65.0
            GridlineThemeColorIndex =1
            GridlineShade =65.0
        End
        Begin TextBox
            AddColon = NotDefault
            FELineBreak = NotDefault
            BorderLineStyle =0
            Width =1701
            LabelX =-1701
            FontSize =11
            FontName ="Calibri"
            AsianLineBreak =1
            BackThemeColorIndex =1
            BorderThemeColorIndex =1
            BorderShade =65.0
            ThemeFontIndex =1
            ForeThemeColorIndex =0
            ForeTint =75.0
            GridlineThemeColorIndex =1
            GridlineShade =65.0
        End
        Begin ListBox
            BorderLineStyle =0
            Width =1701
            Height =1417
            LabelX =-1701
            FontSize =11
            FontName ="Calibri"
            AllowValueListEdits =1
            InheritValueList =1
            ThemeFontIndex =1
            BackThemeColorIndex =1
            BorderThemeColorIndex =1
            BorderShade =65.0
            ForeThemeColorIndex =0
            ForeTint =75.0
            GridlineThemeColorIndex =1
            GridlineShade =65.0
        End
        Begin ComboBox
            AddColon = NotDefault
            BorderLineStyle =0
            Width =1701
            LabelX =-1701
            FontSize =11
            FontName ="Calibri"
            AllowValueListEdits =1
            InheritValueList =1
            ThemeFontIndex =1
            BackThemeColorIndex =1
            BorderThemeColorIndex =1
            BorderShade =65.0
            ForeThemeColorIndex =2
            ForeShade =50.0
            GridlineThemeColorIndex =1
            GridlineShade =65.0
        End
        Begin Subform
            BorderLineStyle =0
            Width =1701
            Height =1701
            BorderThemeColorIndex =1
            GridlineThemeColorIndex =1
            GridlineShade =65.0
            BorderShade =65.0
            ShowPageHeaderAndPageFooter =1
        End
        Begin UnboundObjectFrame
            SpecialEffect =2
            OldBorderStyle =1
            Width =4536
            Height =2835
            ThemeFontIndex =1
            BackThemeColorIndex =1
            BorderThemeColorIndex =1
            BorderShade =65.0
            ForeThemeColorIndex =2
            ForeShade =50.0
            GridlineThemeColorIndex =1
            GridlineShade =65.0
        End
        Begin PageBreak
            Width =283
        End
        Begin CustomControl
            OldBorderStyle =1
            Width =4536
            Height =2835
            BackThemeColorIndex =1
            BorderThemeColorIndex =1
            BorderShade =65.0
            GridlineThemeColorIndex =1
            GridlineShade =65.0
        End
        Begin Tab
            Width =5103
            Height =3402
            FontSize =11
            FontName ="Calibri"
            ThemeFontIndex =0
            GridlineThemeColorIndex =1
            GridlineShade =65.0
            UseTheme =1
            Shape =3
            BackThemeColorIndex =1
            BackShade =85.0
            BorderLineStyle =0
            BorderThemeColorIndex =2
            BorderTint =60.0
            HoverThemeColorIndex =1
            PressedThemeColorIndex =1
            HoverForeThemeColorIndex =0
            HoverForeTint =75.0
            PressedForeThemeColorIndex =0
            PressedForeTint =75.0
            ForeThemeColorIndex =0
            ForeTint =75.0
        End
        Begin Page
            Width =1701
            Height =1701
            BorderThemeColorIndex =1
            BorderShade =65.0
            GridlineThemeColorIndex =1
            GridlineShade =65.0
        End
        Begin EmptyCell
            Height =240
            GridlineThemeColorIndex =1
            GridlineShade =65.0
        End
        Begin NavigationControl
            BorderWidth =1
            BorderLineStyle =0
            BackThemeColorIndex =1
            BorderThemeColorIndex =1
            GridlineThemeColorIndex =1
            GridlineShade =65.0
        End
        Begin NavigationButton
            Width =283
            Height =283
            ForeColor =-2
            GridlineThemeColorIndex =1
            GridlineShade =65.0
            HoverColor =-2
            HoverThemeColorIndex =2
            HoverTint =20.0
            PressedColor =-2
            PressedThemeColorIndex =2
            PressedTint =60.0
            HoverForeColor =-2
            HoverForeThemeColorIndex =0
            HoverForeTint =75.0
            PressedForeColor =-2
            PressedForeThemeColorIndex =0
            PressedForeTint =75.0
            BackThemeColorIndex =1
            OldBorderStyle =0
            BorderLineStyle =0
            BorderThemeColorIndex =3
            BorderShade =90.0
            ThemeFontIndex =1
            FontName ="Calibri"
            FontWeight =400
            FontSize =11
            ForeThemeColorIndex =0
            ForeTint =75.0
        End
        Begin Section
            CanGrow = NotDefault
            CanShrink = NotDefault
            Height =2865
            Name ="Detalle"
            AlternateBackThemeColorIndex =4
            AlternateBackTint =40.0
            BackThemeColorIndex =9
            BackTint =40.0
            Begin
                Begin Subform
                    CanGrow = NotDefault
                    TabStop = NotDefault
                    OverlapFlags =85
                    OldBorderStyle =0
                    Top =15
                    Width =3433
                    Height =2835
                    TabIndex =1
                    BorderColor =10921638
                    Name ="DS_WORKSHEET"
                    SourceObject ="Form.DS_WORKSHEET"
                    GroupTable =2
                    LeftPadding =0
                    TopPadding =15
                    RightPadding =0
                    BottomPadding =0
                    GridlineColor =10921638

                    LayoutCachedTop =15
                    LayoutCachedWidth =3433
                    LayoutCachedHeight =2850
                    LayoutGroup =1
                    GroupTable =2
                End
                Begin CommandButton
                    OverlapFlags =85
                    TextFontCharSet =177
                    TextFontFamily =0
                    Width =15
                    Height =15
                    FontSize =1
                    FontWeight =100
                    Name ="HiddenControl"
                    Caption ="Comando1435"
                    LeftPadding =0
                    TopPadding =0
                    RightPadding =0
                    BottomPadding =0
                    GridlineColor =10921638

                    LayoutCachedWidth =15
                    LayoutCachedHeight =15
                    Alignment =1
                    ForeThemeColorIndex =1
                    ForeTint =100.0
                    Shape =0
                    Gradient =0
                    BackThemeColorIndex =1
                    BackTint =100.0
                    OldBorderStyle =0
                    BorderThemeColorIndex =1
                    BorderTint =100.0
                    HoverColor =-2
                    HoverThemeColorIndex =-1
                    HoverTint =80.0
                    PressedColor =-2
                    PressedThemeColorIndex =-1
                    PressedShade =80.0
                    HoverForeColor =0
                    HoverForeTint =100.0
                    PressedForeColor =0
                    PressedForeTint =100.0
                    QuickStyle =4
                    QuickStyleMask =-1009
                    Overlaps =1
                End
            End
        End
    End
End
CodeBehindForm
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = True
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Option Compare Database
Option Explicit

Private Declare PtrSafe Function SendMessage Lib "user32" Alias "SendMessageA" (ByVal hWnd As LongPtr, ByVal wMsg As Long, ByVal wParam As LongPtr, lParam As Any) As LongPtr

Private Const WM_VSCROLL = &H115
Private Const SB_LINEUP = 0
Private Const SB_LINEDOWN = 1
Private Const SB_TOP = 6

Private pWorksheet As Form_DS_WORKSHEET
Private pScrollview As Form_DS_SCROLLVIEW

' The current ColumnsToLargeChangeTrack value used in CachedTracks, CachedTracks resets when this value changes
Private pTrackColumnSizesInCache As Long
Const NumPagesInLargeChangeRows As Long = 5
Const PageSize As Long = 10
Const PageCount As Long = 10

Private Type TViewportState
    ScrollPosX As Long
    ScrollPosY As Long
    ' Index of current visible track in Viewport
    TrackIndex As Long
    ' Index of current visible page in Viewport
    PageIndex As Long
    ' Index of the first visible column in **Table**
    FirstVisibleColumn As Long
    ' Index of the first visible row in **Table**
    FirstVisibleRow As Long
    ' The distance between the start of the first visible column to the viewport left edge (must be less than GridCellSizeX)
    FirstVisibleColumnPositionModX As Long
    ' Index of the first visible column relative to current visible **Track**
    FirstVisibleColumnInTrack As Long
    ' Index of the first visible row relative to current visible **Page**
    FirstVisibleRowInPage As Long
    ' Number of columns as the distance between track switching
    ColumnsToLargeChangeTrack As Long
    ' The distance from the current track left edge to the viewport left edge
    TrackPositionModX As Long
End Type

Private this As TViewportState

' ---

Private pScrollX As Long
Private pScrollY As Long

Private pScrollModX As Long
Private pScrollModY As Long

Public Property Get Worksheet() As Form_DS_WORKSHEET: Set Worksheet = pWorksheet: End Property
Public Property Set Worksheet(ByRef Value As Form_DS_WORKSHEET): Set pWorksheet = Value: End Property

Public Property Get Scrollview() As Form_DS_SCROLLVIEW: Set Scrollview = pScrollview: End Property
Public Property Set Scrollview(ByRef Value As Form_DS_SCROLLVIEW): Set pScrollview = Value: End Property

Friend Property Get FirstColumnIndex() As Long: FirstColumnIndex = this.TrackIndex * this.ColumnsToLargeChangeTrack: End Property

Property Get IsSubform() As Boolean: On Error Resume Next: IsSubform = Len(Me.Parent.Name) > 0: End Property


' --- FORM EVENTS ---

Private Sub Form_Unload(Cancel As Integer)
    On Error Resume Next
    Me.TimerInterval = 0
End Sub


' --- SETUP / BINDING ---

Public Sub Setup()
    Dim r As ScreenLib.RECT, b As ScreenLib.BOUNDS, t As Long
    
    Set Worksheet = Me.DS_WORKSHEET.Form
    Set Worksheet.Viewport = Me
    Worksheet.Setup
    
    r = ScreenLib.GetScreenRectOfPoint(ScreenLib.PointInRect(ScreenLib.GetWindowRect(Me), DirectionType.Center), True)
    b = ScreenLib.RectToBounds(r)
    
    t = Worksheet.MaxContentWidthLimit
    Me.Width = t
    Me.Detalle.Height = CLng(Min(b.h * 1.95, 31500))
    With Me.DS_WORKSHEET
        .Left = 0
        .Top = 0
        .Width = t
        .Height = CLng(Min(b.h * 1.95, 31500))
    End With
End Sub


' --- SCROLLING ---

Public Function PropagateMouseWheel(ByVal Page As Boolean, ByVal Count As Long)
    On Error Resume Next
    pScrollview.PropagateMouseWheel Page, Count
End Function

Public Sub ScrollTo(ByVal X As Long, ByVal Y As Long)
    Dim sView As TViewportState, lgChanged As Boolean
    
    sView = GetViewportStateAt(X, Y)
    WindowMoveTo pWorksheet, 0 - sView.TrackPositionModX, 0
    
    If this.TrackIndex <> sView.TrackIndex Or this.PageIndex <> sView.PageIndex Or pTrackColumnSizesInCache <> sView.ColumnsToLargeChangeTrack Then
        pTrackColumnSizesInCache = sView.ColumnsToLargeChangeTrack
        Set Worksheet.Recordset = GetTrack(sView.TrackIndex, sView.PageIndex).Instance
        Worksheet.SetupColumns sView.TrackIndex * sView.ColumnsToLargeChangeTrack, Scrollview.Table
    End If
    
    AdjustScrollY sView
    this = sView
End Sub

Private Sub AdjustScrollY(ByRef sView As TViewportState)
    Dim rowOrigin As Long, hW As LongPtr, i As Long
    
    rowOrigin = this.FirstVisibleRowInPage
    hW = Worksheet.hWnd
    If this.PageIndex <> sView.PageIndex Then
        SendMessage hW, WM_VSCROLL, SB_TOP, 0&
        rowOrigin = 0
    End If
    If rowOrigin <> sView.FirstVisibleRowInPage Then
        Worksheet.Painting = False
        If rowOrigin < sView.FirstVisibleRowInPage Then
            For i = rowOrigin To sView.FirstVisibleRowInPage - 1
                SendMessage hW, WM_VSCROLL, SB_LINEDOWN, 0&
            Next i
        ElseIf rowOrigin > sView.FirstVisibleRowInPage Then
            For i = rowOrigin - 1 To sView.FirstVisibleRowInPage Step -1
                SendMessage hW, WM_VSCROLL, SB_LINEUP, 0&
            Next i
        End If
        Worksheet.Painting = True
    End If
End Sub


' --- STATE MANAGEMENT ---

Private Function GetViewportStateAt(ByVal X As Long, ByVal Y As Long) As TViewportState
    Dim t As TViewportState, maxTrackWidth As Long, cellWidth As Long, viewWidth As Long, cellHeight As Long
    
    t.ScrollPosX = X
    t.ScrollPosY = Y
    
    maxTrackWidth = Worksheet.MaxContentWidthLimit
    cellWidth = Worksheet.GridCellSizeX
    cellHeight = Worksheet.GridCellSizeY
    viewWidth = Scrollview.ScrollPageSizeX
    
    t.ColumnsToLargeChangeTrack = Max(CLng((maxTrackWidth - viewWidth) / cellWidth) - 1, 1)
    
    t.FirstVisibleColumn = CLng(Int(X / cellWidth))
    t.FirstVisibleRow = CLng(Int(Y / cellHeight))
    t.FirstVisibleColumnPositionModX = X Mod cellWidth
    t.TrackIndex = CLng(Int(X / (cellWidth * t.ColumnsToLargeChangeTrack)))
    t.PageIndex = CLng(Int(t.FirstVisibleRow / (PageSize * NumPagesInLargeChangeRows)))
    t.FirstVisibleColumnInTrack = t.FirstVisibleColumn - (t.ColumnsToLargeChangeTrack * t.TrackIndex)
    t.FirstVisibleRowInPage = t.FirstVisibleRow - (t.PageIndex * PageSize * NumPagesInLargeChangeRows)
    t.TrackPositionModX = (t.FirstVisibleColumnInTrack * cellWidth) + t.FirstVisibleColumnPositionModX
    
    GetViewportStateAt = t
End Function

Public Sub OnSourceTableChange()
    this.TrackIndex = -1
    If Scrollview.KeepScrollPositionOnTableChange Then
        ScrollTo this.ScrollPosX, this.ScrollPosY
    Else
        ScrollTo 0, 0
    End If
End Sub

Private Function GetTrack(ByVal TrackIndex As Long, ByVal PageIndex As Long) As RecordsetEx
    Dim dsT As dsTable, rX As RecordsetEx, ColumnStartIndex As Long, nCols As Long, dsT2 As dsTable, dsT3 As dsTable, nRows As Long

    Set dsT = Scrollview.Table
    ColumnStartIndex = TrackIndex * pTrackColumnSizesInCache
    nCols = Worksheet.MaxAvailColumns

    If ColumnStartIndex >= dsT.ColumnCount Then
        Set rX = RecordsetEx.Create(CreateBlankRecordset(PageSize * PageCount, 0, nCols))
    Else
        If dsT.ColumnCount - ColumnStartIndex > nCols Then
            Set rX = RecordsetEx.Create(dsT.CreateIndexRecordset(PageSize, PageIndex * NumPagesInLargeChangeRows, PageCount, ColumnStartIndex, nCols, True))
        Else
            nRows = Min(dsT.Count - (PageSize * PageIndex * NumPagesInLargeChangeRows), PageSize * PageCount)
            Set dsT2 = dsT.GetRange(PageSize * PageIndex * NumPagesInLargeChangeRows, nRows, ArrayRange(ColumnStartIndex, dsT.ColumnCount - 1))
            Set dsT3 = CreateBlankTable(nRows, nCols - (dsT.ColumnCount - ColumnStartIndex))
            Set dsT2 = dsT2.Join(dsT3)
            Set rX = RecordsetEx.Create(dsT2.IndexRecordset)
        End If
    End If
    
    Set GetTrack = rX
End Function


' --- HELPERS ---

Private Function Max(X As Variant, Y As Variant) As Variant: Max = IIf(X > Y, X, Y): End Function
Private Function Min(X As Variant, Y As Variant) As Variant: Min = IIf(X < Y, X, Y): End Function
