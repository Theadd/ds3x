Version =20
VersionRequired =20
Begin Form
    PopUp = NotDefault
    RecordSelectors = NotDefault
    FastLaserPrinting = NotDefault
    AutoCenter = NotDefault
    NavigationButtons = NotDefault
    DividingLines = NotDefault
    KeyPreview = NotDefault
    DataEntry = NotDefault
    AllowDesignChanges = NotDefault
    DefaultView =0
    ScrollBars =0
    ViewsAllowed =1
    TabularCharSet =177
    TabularFamily =0
    PictureAlignment =2
    DatasheetGridlinesBehavior =3
    GridY =10
    Width =3436
    DatasheetFontHeight =11
    ItemSuffix =1559
    Left =14625
    Top =-12780
    Right =26325
    Bottom =-5715
    OnUnload ="[Event Procedure]"
    RecSrcDt = Begin
        0x4a0577b4d2d8e540
    End
    Caption ="dsLiveEd - TEST"
    DatasheetFontName ="Calibri"
    AllowDatasheetView =0
    FilterOnLoad =0
    SplitFormDatasheet =1
    SplitFormDatasheet =1
    ShowPageMargins =0
    DisplayOnSharePointSite =1
    DatasheetAlternateBackColor =15921906
    DatasheetGridlinesColor12 =0
    FitToScreen =255
    DatasheetBackThemeColorIndex =1
    BorderThemeColorIndex =3
    ThemeFontIndex =1
    ForeThemeColorIndex =0
    AlternateBackThemeColorIndex =1
    AlternateBackShade =95.0
    Begin
        Begin Label
            BackStyle =0
            FontSize =11
            FontName ="Calibri"
            ThemeFontIndex =1
            BackThemeColorIndex =1
            BorderThemeColorIndex =0
            BorderTint =50.0
            ForeThemeColorIndex =0
            ForeTint =50.0
            GridlineThemeColorIndex =1
            GridlineShade =65.0
        End
        Begin Rectangle
            SpecialEffect =3
            BackStyle =0
            BorderLineStyle =0
            Width =850
            Height =850
            BorderShade =65.0
            GridlineShade =65.0
        End
        Begin CommandButton
            Width =1701
            Height =283
            FontSize =11
            FontWeight =400
            FontName ="Calibri"
            ForeThemeColorIndex =0
            ForeTint =75.0
            GridlineThemeColorIndex =1
            GridlineShade =65.0
            UseTheme =1
            Shape =1
            Gradient =12
            BackThemeColorIndex =4
            BackTint =60.0
            BorderLineStyle =0
            BorderThemeColorIndex =4
            BorderTint =60.0
            ThemeFontIndex =1
            HoverThemeColorIndex =4
            HoverTint =40.0
            PressedThemeColorIndex =4
            PressedShade =75.0
            HoverForeThemeColorIndex =0
            HoverForeTint =75.0
            PressedForeThemeColorIndex =0
            PressedForeTint =75.0
        End
        Begin OptionButton
            BorderLineStyle =0
            LabelX =230
            LabelY =-30
            BorderThemeColorIndex =1
            BorderShade =65.0
            GridlineThemeColorIndex =1
            GridlineShade =65.0
        End
        Begin CheckBox
            BorderLineStyle =0
            LabelX =230
            LabelY =-30
            BorderThemeColorIndex =1
            BorderShade =65.0
            GridlineThemeColorIndex =1
            GridlineShade =65.0
        End
        Begin OptionGroup
            SpecialEffect =3
            BorderLineStyle =0
            Width =1701
            Height =1701
            BackThemeColorIndex =1
            BorderThemeColorIndex =1
            BorderShade =65.0
            GridlineThemeColorIndex =1
            GridlineShade =65.0
        End
        Begin BoundObjectFrame
            AddColon = NotDefault
            SizeMode =3
            SpecialEffect =2
            BorderLineStyle =0
            Width =4536
            Height =2835
            LabelX =-1701
            BackThemeColorIndex =1
            BorderThemeColorIndex =1
            BorderShade =65.0
            GridlineThemeColorIndex =1
            GridlineShade =65.0
        End
        Begin TextBox
            AddColon = NotDefault
            FELineBreak = NotDefault
            BorderLineStyle =0
            Width =1701
            LabelX =-1701
            FontSize =11
            FontName ="Calibri"
            AsianLineBreak =1
            BackThemeColorIndex =1
            BorderThemeColorIndex =1
            BorderShade =65.0
            ThemeFontIndex =1
            ForeThemeColorIndex =0
            ForeTint =75.0
            GridlineThemeColorIndex =1
            GridlineShade =65.0
        End
        Begin ListBox
            BorderLineStyle =0
            Width =1701
            Height =1417
            LabelX =-1701
            FontSize =11
            FontName ="Calibri"
            AllowValueListEdits =1
            InheritValueList =1
            ThemeFontIndex =1
            BackThemeColorIndex =1
            BorderThemeColorIndex =1
            BorderShade =65.0
            ForeThemeColorIndex =0
            ForeTint =75.0
            GridlineThemeColorIndex =1
            GridlineShade =65.0
        End
        Begin ComboBox
            AddColon = NotDefault
            BorderLineStyle =0
            Width =1701
            LabelX =-1701
            FontSize =11
            FontName ="Calibri"
            AllowValueListEdits =1
            InheritValueList =1
            ThemeFontIndex =1
            BackThemeColorIndex =1
            BorderThemeColorIndex =1
            BorderShade =65.0
            ForeThemeColorIndex =2
            ForeShade =50.0
            GridlineThemeColorIndex =1
            GridlineShade =65.0
        End
        Begin Subform
            BorderLineStyle =0
            Width =1701
            Height =1701
            BorderThemeColorIndex =1
            GridlineThemeColorIndex =1
            GridlineShade =65.0
            BorderShade =65.0
            ShowPageHeaderAndPageFooter =1
        End
        Begin UnboundObjectFrame
            SpecialEffect =2
            OldBorderStyle =1
            Width =4536
            Height =2835
            ThemeFontIndex =1
            BackThemeColorIndex =1
            BorderThemeColorIndex =1
            BorderShade =65.0
            ForeThemeColorIndex =2
            ForeShade =50.0
            GridlineThemeColorIndex =1
            GridlineShade =65.0
        End
        Begin PageBreak
            Width =283
        End
        Begin CustomControl
            OldBorderStyle =1
            Width =4536
            Height =2835
            BackThemeColorIndex =1
            BorderThemeColorIndex =1
            BorderShade =65.0
            GridlineThemeColorIndex =1
            GridlineShade =65.0
        End
        Begin Tab
            Width =5103
            Height =3402
            FontSize =11
            FontName ="Calibri"
            ThemeFontIndex =0
            GridlineThemeColorIndex =1
            GridlineShade =65.0
            UseTheme =1
            Shape =3
            BackThemeColorIndex =1
            BackShade =85.0
            BorderLineStyle =0
            BorderThemeColorIndex =2
            BorderTint =60.0
            HoverThemeColorIndex =1
            PressedThemeColorIndex =1
            HoverForeThemeColorIndex =0
            HoverForeTint =75.0
            PressedForeThemeColorIndex =0
            PressedForeTint =75.0
            ForeThemeColorIndex =0
            ForeTint =75.0
        End
        Begin Page
            Width =1701
            Height =1701
            BorderThemeColorIndex =1
            BorderShade =65.0
            GridlineThemeColorIndex =1
            GridlineShade =65.0
        End
        Begin EmptyCell
            Height =240
            GridlineThemeColorIndex =1
            GridlineShade =65.0
        End
        Begin NavigationControl
            BorderWidth =1
            BorderLineStyle =0
            BackThemeColorIndex =1
            BorderThemeColorIndex =1
            GridlineThemeColorIndex =1
            GridlineShade =65.0
        End
        Begin NavigationButton
            Width =283
            Height =283
            ForeColor =-2
            GridlineThemeColorIndex =1
            GridlineShade =65.0
            HoverColor =-2
            HoverThemeColorIndex =2
            HoverTint =20.0
            PressedColor =-2
            PressedThemeColorIndex =2
            PressedTint =60.0
            HoverForeColor =-2
            HoverForeThemeColorIndex =0
            HoverForeTint =75.0
            PressedForeColor =-2
            PressedForeThemeColorIndex =0
            PressedForeTint =75.0
            BackThemeColorIndex =1
            OldBorderStyle =0
            BorderLineStyle =0
            BorderThemeColorIndex =3
            BorderShade =90.0
            ThemeFontIndex =1
            FontName ="Calibri"
            FontWeight =400
            FontSize =11
            ForeThemeColorIndex =0
            ForeTint =75.0
        End
        Begin Section
            CanGrow = NotDefault
            CanShrink = NotDefault
            Height =2865
            Name ="Detalle"
            AlternateBackThemeColorIndex =4
            AlternateBackTint =40.0
            BackThemeColorIndex =9
            BackTint =40.0
            Begin
                Begin Subform
                    CanGrow = NotDefault
                    TabStop = NotDefault
                    OverlapFlags =85
                    OldBorderStyle =0
                    Top =15
                    Width =3433
                    Height =2835
                    TabIndex =1
                    BorderColor =10921638
                    Name ="DS_WORKSHEET"
                    SourceObject ="Form.DS_WORKSHEET"
                    GroupTable =2
                    LeftPadding =0
                    TopPadding =15
                    RightPadding =0
                    BottomPadding =0
                    GridlineColor =10921638

                    LayoutCachedTop =15
                    LayoutCachedWidth =3433
                    LayoutCachedHeight =2850
                    LayoutGroup =1
                    GroupTable =2
                End
                Begin CommandButton
                    OverlapFlags =85
                    TextFontCharSet =177
                    TextFontFamily =0
                    Width =15
                    Height =15
                    FontSize =1
                    FontWeight =100
                    Name ="HiddenControl"
                    Caption ="Comando1435"
                    LeftPadding =0
                    TopPadding =0
                    RightPadding =0
                    BottomPadding =0
                    GridlineColor =10921638

                    LayoutCachedWidth =15
                    LayoutCachedHeight =15
                    Alignment =1
                    ForeThemeColorIndex =1
                    ForeTint =100.0
                    Shape =0
                    Gradient =0
                    BackThemeColorIndex =1
                    BackTint =100.0
                    OldBorderStyle =0
                    BorderThemeColorIndex =1
                    BorderTint =100.0
                    HoverColor =-2
                    HoverThemeColorIndex =-1
                    HoverTint =80.0
                    PressedColor =-2
                    PressedThemeColorIndex =-1
                    PressedShade =80.0
                    HoverForeColor =0
                    HoverForeTint =100.0
                    PressedForeColor =0
                    PressedForeTint =100.0
                    QuickStyle =4
                    QuickStyleMask =-1009
                    Overlaps =1
                End
            End
        End
    End
End
CodeBehindForm
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = True
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Option Compare Database
Option Explicit

'             /* WindowMoveTo Worksheet, (pScrollModX - pScrollX), (pScrollModY - pScrollY) */
'
'                                         (18000)
'              ____________ * ScrollView.InsideWidth    _______ * ScrollView.OutOfBoundsScrollX
'             |____________|___________________________|_______|
'             |________________________________________|
'             |_____________________|                   * Viewport.ViewportContentFullWidth      -> All dsTable Columns Width
'                                    * Worksheet.MaxContentWidthLimit (30000)   -> Worksheet form' max width (~22 inches)
'                          :--------:
'                                    * .MaxFlexSpaceX (6000)
'                          :--::
'                              * .RSafeMarginX (2000 + 1000)
'       |_____________________|
'                              * Viewport.ScrollTo (4000)
'         ::--:
'              * .LSafeMarginX (1000 + 2000)
'          |_____________________|
'
'                                [pScrollX] [pScrollModX]

Private pWorksheet As Form_DS_WORKSHEET
' Private pWorksheetAux As Form_DS_WORKSHEET
Private pScrollView As Form_DS_SCROLLVIEW

'                 if X < (3) jumps to (1)
'                  <------------<
' pTrackStops: [0, 1,        2, 3]
'               >------------>     ... if X > (0) jumps to (2)

' 1 (TrackStop1/RS1) is for moving backwards (scrolls left / heads to first column) and the one initially rendered.
Private pTrackStopRS1 As RecordsetEx
' 2 (TrackStop2/RS2) is for moving forwards (scrolls right / heads to last column)
Private pTrackStopRS2 As RecordsetEx
' N (RSN) preloads the recordset for the next jump of the current TrackStop(1/2) origin (the last jump done)
Private pTrackStopRSN As RecordsetEx
' Array(0, 1, 2, 3) of TrackStop's points on the X axis (in absolute values)
Private pTrackStops As Variant
' Tells the TrackStop that the current viewport positioning is based on.
'''''''''''''''''''''''''''''''''''''''''''''''''''''' NOTE: RS1 is initially rendered but since scrolling forward is possible from there, this value is set to 2 (RS2/forwards).
Private pCurrentTrackStopOrigin As Long
' The number of Worksheet columns between jumps
Private pAllowedTrackMoves As Long
' Dirty flag for TrackStopRSN
Private pIsDirtyRSN As Boolean
' The Track index being rendered in the Worksheet (X axis).
Private pCurrentTrackIndex As Long
' Maximum distance between calls to ScrollTo()
Private pMaxScrollStepX As Long

' TODO: Event actions for changes on source dsTable to rebuild Right and Left RecordsetEx's


Private pScrollX As Long
Private pScrollY As Long

Private pScrollModX As Long
Private pScrollModY As Long

Public Property Get Worksheet() As Form_DS_WORKSHEET: Set Worksheet = pWorksheet: End Property
Public Property Set Worksheet(ByRef Value As Form_DS_WORKSHEET): Set pWorksheet = Value: End Property

Public Property Get ScrollView() As Form_DS_SCROLLVIEW: Set ScrollView = pScrollView: End Property
Public Property Set ScrollView(ByRef Value As Form_DS_SCROLLVIEW): Set pScrollView = Value: End Property

Public Property Get CurrentTrackIndex() As Long: CurrentTrackIndex = pCurrentTrackIndex: End Property
Public Property Let CurrentTrackIndex(ByVal Value As Long): pCurrentTrackIndex = Value: End Property

Property Get IsSubform() As Boolean: On Error Resume Next: IsSubform = Len(Me.Parent.Name) > 0: End Property

' --- VIEWPORT CONTENT PROPERTIES ---

' ViewportContentFullWidth = (Total Columns in dsTable * Grid Cell Width)
Public Property Get ViewportContentFullWidth() As Long
    On Error Resume Next
    ViewportContentFullWidth = pScrollView.Table.ColumnCount * Worksheet.DS_HC_2_2.Left
End Property



' --- FORM EVENTS ---

Private Sub Form_Unload(Cancel As Integer)
    On Error Resume Next
    Me.TimerInterval = 0
End Sub


' --- SETUP / BINDING ---

Public Sub Setup()
    Dim r As ScreenLib.RECT, b As ScreenLib.BOUNDS, t As Long
    
    Set Worksheet = Me.DS_WORKSHEET.Form
    Set Worksheet.Viewport = Me
    Worksheet.Setup
    
    r = ScreenLib.GetScreenRectOfPoint(ScreenLib.PointInRect(ScreenLib.GetWindowRect(Me), DirectionType.Center), True)
    b = ScreenLib.RectToBounds(r)
    
    Debug.Print Printf("Bounds.Width: %1, Worksheet.InsideWidth: %2", b.W, Worksheet.InsideWidth)
    
    t = Worksheet.MaxContentWidthLimit

    Me.Width = t
    Me.Detalle.Height = CLng(b.h * 1.5)
    With Me.DS_WORKSHEET
        .Left = 0
        .Top = 0
        .Width = t
        .Height = CLng(b.h * 1.5)
    End With
End Sub


' --- SCROLLING ---

Public Function PropagateMouseWheel(ByVal Page As Boolean, ByVal Count As Long)
    On Error Resume Next
    pScrollView.PropagateMouseWheel Page, Count
End Function

' Private Function SeamlessTrackShift(ByRef TargetWorksheet As Form_DS_WORKSHEET, ByRef rX As RecordsetEx) As Long
Private Function SeamlessTrackShift(ByVal TrackStopIndex As Long) As Long
    ' Dim rX As RecordsetEx
    ' 2 -> 2: RS1 = RS2, RS2 = RSN,                 RSN = Dirty
    ' 2 -> 1: RS1 = RS1, RS2 = RS2,                 RSN = Dirty
    ' 1 -> 2: RS1 = RS1, RS2 = RS2,                 RSN = Dirty
    ' 1 -> 1: RS2 = RS1, RS1 = RSN,                 RSN = Dirty
    Debug.Print "SHIFTING"
    Select Case TrackStopIndex
        Case 1
            pCurrentTrackIndex = pCurrentTrackIndex - 1
            If pCurrentTrackStopOrigin = 1 Then
                ' Set rX = pTrackStopRS1
                Set pTrackStopRS2 = pTrackStopRS1
                Set pTrackStopRS1 = pTrackStopRSN
            End If
            Set Worksheet.Recordset = pTrackStopRS1.Instance
            
        Case 2
            pCurrentTrackIndex = pCurrentTrackIndex + 1
            If pCurrentTrackStopOrigin = 2 Then
                ' Set rX = pTrackStopRS2
                Set pTrackStopRS1 = pTrackStopRS2
                Set pTrackStopRS2 = pTrackStopRSN
            End If
            Set Worksheet.Recordset = pTrackStopRS2.Instance
            
    End Select
    If pCurrentTrackIndex > 0 Then pIsDirtyRSN = True
    pCurrentTrackStopOrigin = TrackStopIndex
    ' TODO: REMOVE BELOW
    ScrollView.Monitor "TrackIndex", pCurrentTrackIndex
End Function

Private Sub JumpToTrackStop(ByVal TrackStopIndex As Long, ByVal sX As Long, ByVal sY As Long)
    Dim sMod As Long
    
    ScrollView.Monitor "VMem", CStr(ScrollView.AvailableVMemOnLoad - GetAvailableVirtualMemory) & " MB"
    SeamlessTrackShift TrackStopIndex
    
    Select Case TrackStopIndex
        Case 1
            ' TODO: DoEvents after implementing Event pooling
            sMod = (pTrackStops(3) - pTrackStops(1))
            ' WindowMoveTo Worksheet, (0 - sX) - sMod + (pTrackStops(3) - sX), 0 - sY
            'WindowMoveTo Worksheet, (0 - sX) - sMod + pScrollModX + (pTrackStops(3) - sX), 0 - sY
            Debug.Print Printf("(3 -> 1) = pScrollModX + (pTrackStops(3) - pTrackStops(1)) - (pTrackStops(3) - sX): %1 + (%2 - %3) - (%2 - %4) = %1 + (%5) - (%6) = %7", _
                pScrollModX, pTrackStops(3), pTrackStops(1), sX, pTrackStops(3) - pTrackStops(1), pTrackStops(3) - sX, pScrollModX + sMod - (pTrackStops(3) - sX))
'            pScrollModX = pScrollModX + sMod - (pTrackStops(3) - sX)
            pScrollModX = pScrollModX + sMod + (pTrackStops(3) - sX)
        Case 2
            ' TODO: DoEvents
            If (pTrackStops(0) - sX) > 0 Then
                ' TODO: Remove (assert: should be negative)
                Stop
            End If
            sMod = (pTrackStops(0) - pTrackStops(2))
            ' WindowMoveTo Worksheet, (0 - sX) - sMod + (pTrackStops(0) - sX), 0 - sY
            Debug.Print Printf("(0 -> 2) = pScrollModX + (pTrackStops(0) - pTrackStops(2)) + (pTrackStops(0) - sX): %1 + (%2 - %3) + (%2 - %4) = %1 + (%5) + (%6) = %7", _
                pScrollModX, pTrackStops(0), pTrackStops(2), sX, pTrackStops(0) - pTrackStops(2), pTrackStops(0) - sX, pScrollModX + sMod + (pTrackStops(0) - sX))
            pScrollModX = pScrollModX + sMod + (pTrackStops(0) - sX)
'            pScrollModX = pScrollModX + sMod - (pTrackStops(0) - sX)
        Case Else
            Err.Raise 17, , "Nonsense."
    End Select
    ScrollView.Monitor "LastJumpTo", TrackStopIndex
    ScrollView.Monitor "VMem", CStr(ScrollView.AvailableVMemOnLoad - GetAvailableVirtualMemory) & " MB"
End Sub

Public Sub ScrollTo(Optional ByVal ScrollPosX As Variant, Optional ByVal ScrollPosY As Variant)
    Dim sValue As Long
    If IsMissing(ScrollPosX) Then ScrollPosX = pScrollX
    If IsMissing(ScrollPosY) Then ScrollPosY = pScrollY
    
    If Abs(pScrollX - ScrollPosX) > pMaxScrollStepX Then
        sValue = pScrollX
        If pScrollX < ScrollPosX Then
            Do
                sValue = sValue + pMaxScrollStepX
                If sValue >= ScrollPosX Then sValue = ScrollPosX
                ScrollWorksheetTo sValue, ScrollPosY
            Loop Until (sValue = ScrollPosX)
        Else
            Do
                sValue = sValue - pMaxScrollStepX
                If sValue <= ScrollPosX Then sValue = ScrollPosX
                ScrollWorksheetTo sValue, ScrollPosY
            Loop Until (sValue = ScrollPosX)
        End If
    Else
        ScrollWorksheetTo ScrollPosX, ScrollPosY
    End If
End Sub

Private Sub ScrollWorksheetTo(ByVal ScrollPosX As Variant, ByVal ScrollPosY As Variant)
    Static pCallCount As Long
    ' TODO: Remove
    Dim iAux As Long
    On Error GoTo 0
    
    pCallCount = pCallCount + 1
    If pCallCount > 1 Then Debug.Print "[WARNING] @Viewport.ScrollTo() - pCallCount: " & CStr(pCallCount)
    If pIsDirtyRSN Then UpdateTrackStopRSN
    ' TODO: Event pooling
    Dim sX As Long, sY As Long, prevX As Long, prevY As Long
'    If IsMissing(ScrollPosX) Then ScrollPosX = pScrollX
'    If IsMissing(ScrollPosY) Then ScrollPosY = pScrollY
    
    '                 if X < (3) jumps to (1)
    '                  <------------<
    ' pTrackStops: [0, 1,        2, 3]
    '               >------------>     ... if X > (0) jumps to (2)
    
    ' sX = (0 - ScrollPosX) + pScrollModX     ' Ik
    sX = ScrollPosX - pScrollModX
    sY = ScrollPosY - pScrollModY
    prevX = pScrollX - pScrollModX
    prevY = pScrollY - pScrollModY
    
    If pScrollX > ScrollPosX Then
        ' Scrolls to the left (to the begginning of the table)
        If prevX > pTrackStops(3) And sX < pTrackStops(3) Then
            ' JUMP! (3) -> (1)
            If ScrollPosX > pTrackStops(3) Then
                iAux = pScrollModX
                JumpToTrackStop 1, sX, sY
                
                sX = ScrollPosX - pScrollModX
                Debug.Print Printf("---> sX FROM %1 (%2 - %3) TO %4 (%5 - %6)", ScrollPosX - iAux, ScrollPosX, iAux, ScrollPosX - pScrollModX, ScrollPosX, pScrollModX)
                WindowMoveTo Worksheet, pTrackStops(3) - sX, 0 - sY
                GoTo Finally
            End If
        End If
    ElseIf pScrollX < ScrollPosX Then
        ' Scrolls RIGHT
        If prevX < pTrackStops(0) And sX > pTrackStops(0) Then
            ' JUMP! (0) -> (2)
            iAux = pScrollModX
            JumpToTrackStop 2, sX, sY
            
            sX = ScrollPosX - pScrollModX
            Debug.Print Printf("---> sX FROM %1 (%2 - %3) TO %4 (%5 - %6)", ScrollPosX - iAux, ScrollPosX, iAux, ScrollPosX - pScrollModX, ScrollPosX, pScrollModX)
            WindowMoveTo Worksheet, pTrackStops(3) - sX, 0 - sY
            GoTo Finally
        End If
    Else
        ' Vertical scrolling not implemented yet, can't reach here, or shouldn't
        Debug.Print "[NOTICE] @Viewport.ScrollTo() - Vertical scrolling not implemented yet, can't reach here, or shouldn't"
    End If
    
    WindowMoveTo Worksheet, pTrackStops(3) - sX, 0 - sY
Finally:
    pScrollX = ScrollPosX
    pScrollY = ScrollPosY
    ' TODO: Remove
'    ScrollView.Monitor "sX", sX
'    ScrollView.Monitor "pScrollX", pScrollX
'    ScrollView.Monitor "pScrollModX", pScrollModX
    pCallCount = pCallCount - 1
End Sub


' --- VIEWPORT CONTENT ---

Public Function OnSourceTableChange()
    Static isFirstRun As Boolean
    RecalculateViewportSizes

    Set Worksheet.Recordset = pTrackStopRS1.Instance
    
    If Not isFirstRun Then
        pCurrentTrackStopOrigin = 1
        pScrollModX = 0 - pTrackStops(3)
        ScrollTo 0, 0
        isFirstRun = True
    End If
End Function

Public Sub RecalculateViewportSizes()
    Dim dsT As dsTable
    
    Set dsT = ScrollView.Table
    ' ws => Worksheet
    ' vw => Viewport
    Dim wsMaxContentWidth As Long, scViewInsideWidth As Long, MaxFlexSpaceX As Long, pCurrentPageIndex As Long
    Dim cellSizeX As Long, cellScrollSafeMoves As Long
    ', outerTrackStopSizeModX As Long
    ' TODO: CurrentPageIndex as a ScrollView property?
    pCurrentPageIndex = ScrollView.CurrentPageIndex
'    wsMaxContentWidth = Worksheet.MaxContentWidthLimit
'    scViewInsideWidth = ScrollView.InsideWidth

    MaxFlexSpaceX = Worksheet.MaxContentWidthLimit - ScrollView.InsideWidth
    cellSizeX = Worksheet.GridCellSizeX
    ' outerTrackStopSizeModX = CLng(cellSizeX * 0.4)
    
    cellScrollSafeMoves = Int(MaxFlexSpaceX / cellSizeX) - 1
    pAllowedTrackMoves = IIf(cellScrollSafeMoves <= 0, 1, cellScrollSafeMoves)
    pMaxScrollStepX = cellSizeX * Int((pAllowedTrackMoves + 1) / 2)
    
'    pTrackStops = Array(cellSizeX * pAllowedTrackMoves, (cellSizeX * pAllowedTrackMoves) - outerTrackStopSizeModX, cellSizeX, outerTrackStopSizeModX)
    pTrackStops = Array(cellSizeX * (pAllowedTrackMoves + 1), cellSizeX * pAllowedTrackMoves, cellSizeX * 2, cellSizeX)

    Set pTrackStopRS1 = RecordsetEx.Create(dsT.CreateIndexRecordset(10, pCurrentPageIndex, 10, 0, , True))
    Set pTrackStopRS2 = RecordsetEx.Create(dsT.CreateIndexRecordset(10, pCurrentPageIndex, 10, pAllowedTrackMoves - 1, , True))
 
    Debug.Print Printf("ScrollView.InsideWidth: %1, Worksheet.MaxContentWidthLimit: %2, MaxFlexSpaceX: %3, pTrackStops: %4", _
        ScrollView.InsideWidth, Worksheet.MaxContentWidthLimit, MaxFlexSpaceX, JSON.Stringify(pTrackStops))
        
    'ScrollView.Monitor "TrackStops", pTrackStops

    
End Sub

Private Sub UpdateTrackStopRSN()
    Dim ColumnStartIndex As Long, dsT As dsTable
    ' TODO: ColumnsCount
    Debug.Print "IN UpdateTrackStopRSN"
    pIsDirtyRSN = False
    ' TODO: Remove
    On Error GoTo StopOnError
    Set dsT = ScrollView.Table
    
    If pCurrentTrackIndex = 9 Then
        ScrollView.Monitor "VMem", CStr(ScrollView.AvailableVMemOnLoad - GetAvailableVirtualMemory) & " MB"
        'Stop
    End If
    Select Case pCurrentTrackStopOrigin
        Case 1
            ColumnStartIndex = ((pCurrentTrackIndex - 1) * pAllowedTrackMoves) - 1
            If ColumnStartIndex < 0 Then ColumnStartIndex = 0
        Case 2
            ColumnStartIndex = ((pCurrentTrackIndex + 1) * pAllowedTrackMoves) - 1
    End Select
    
    If ColumnStartIndex >= dsT.ColumnCount Then
        Set pTrackStopRSN = RecordsetEx.Create(CreateBlankRecordset(100, 0, Worksheet.MaxAvailColumns))
    Else
        Set pTrackStopRSN = RecordsetEx.Create(dsT.CreateIndexRecordset(10, ScrollView.CurrentPageIndex, 10, ColumnStartIndex, , True))
    End If
    ScrollView.Monitor "VMem", CStr(ScrollView.AvailableVMemOnLoad - GetAvailableVirtualMemory) & " MB"
ExitSub:
    Exit Sub
StopOnError:
    Debug.Print Err.Description
    Stop
    Resume Next
End Sub

Private Function CreateBlankRecordset(ByVal RowsCount As Long, ByVal ColumnStartIndex As Long, ByVal ColumnsCount As Long) As ADODB.Recordset
    Dim rs As New ADODB.Recordset, iRow() As Variant, rValues() As Variant, i As Long
    
    ReDim iRow(0 To ColumnsCount - 1)
    ReDim rValues(0 To ColumnsCount - 1)
    
    With rs
        For i = LBound(iRow) To UBound(iRow)
            iRow(i) = CStr(ColumnStartIndex + i)
            .Fields.Append CStr(iRow(i)), adLongVarWChar, -1, adFldIsNullable
            rValues(i) = ""
        Next i
        .Open
        For i = 0 To RowsCount - 1
            .AddNew FieldList:=iRow, Values:=rValues
        Next i
        .MoveFirst
    End With
    
    Set CreateBlankRecordset = rs
End Function
