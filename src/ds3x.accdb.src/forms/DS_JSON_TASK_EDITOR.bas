Version =20
VersionRequired =20
Begin Form
    PopUp = NotDefault
    RecordSelectors = NotDefault
    FastLaserPrinting = NotDefault
    MaxButton = NotDefault
    MinButton = NotDefault
    ShortcutMenu = NotDefault
    AutoCenter = NotDefault
    NavigationButtons = NotDefault
    DividingLines = NotDefault
    KeyPreview = NotDefault
    DataEntry = NotDefault
    AllowDesignChanges = NotDefault
    DefaultView =0
    ScrollBars =0
    ViewsAllowed =1
    TabularCharSet =177
    TabularFamily =0
    PictureAlignment =2
    DatasheetGridlinesBehavior =3
    GridY =10
    Width =3795
    DatasheetFontHeight =11
    ItemSuffix =1558
    Left =4065
    Top =2775
    Right =28545
    Bottom =15345
    OnUnload ="[Event Procedure]"
    RecSrcDt = Begin
        0x4a0577b4d2d8e540
    End
    Caption ="dsJSONTaskEd"
    DatasheetFontName ="Calibri"
    OnKeyDown ="[Event Procedure]"
    OnResize ="[Event Procedure]"
    AllowDatasheetView =0
    FilterOnLoad =0
    SplitFormDatasheet =1
    SplitFormDatasheet =1
    ShowPageMargins =0
    DisplayOnSharePointSite =1
    DatasheetAlternateBackColor =15921906
    DatasheetGridlinesColor12 =0
    FitToScreen =255
    DatasheetBackThemeColorIndex =1
    BorderThemeColorIndex =3
    ThemeFontIndex =1
    ForeThemeColorIndex =0
    AlternateBackThemeColorIndex =1
    AlternateBackShade =95.0
    Begin
        Begin Label
            BackStyle =0
            FontSize =11
            FontName ="Calibri"
            ThemeFontIndex =1
            BackThemeColorIndex =1
            BorderThemeColorIndex =0
            BorderTint =50.0
            ForeThemeColorIndex =0
            ForeTint =50.0
            GridlineThemeColorIndex =1
            GridlineShade =65.0
        End
        Begin Rectangle
            SpecialEffect =3
            BackStyle =0
            BorderLineStyle =0
            Width =850
            Height =850
            BorderShade =65.0
            GridlineShade =65.0
        End
        Begin CommandButton
            Width =1701
            Height =283
            FontSize =11
            FontWeight =400
            FontName ="Calibri"
            ForeThemeColorIndex =0
            ForeTint =75.0
            GridlineThemeColorIndex =1
            GridlineShade =65.0
            UseTheme =1
            Shape =1
            Gradient =12
            BackThemeColorIndex =4
            BackTint =60.0
            BorderLineStyle =0
            BorderThemeColorIndex =4
            BorderTint =60.0
            ThemeFontIndex =1
            HoverThemeColorIndex =4
            HoverTint =40.0
            PressedThemeColorIndex =4
            PressedShade =75.0
            HoverForeThemeColorIndex =0
            HoverForeTint =75.0
            PressedForeThemeColorIndex =0
            PressedForeTint =75.0
        End
        Begin OptionButton
            BorderLineStyle =0
            LabelX =230
            LabelY =-30
            BorderThemeColorIndex =1
            BorderShade =65.0
            GridlineThemeColorIndex =1
            GridlineShade =65.0
        End
        Begin CheckBox
            BorderLineStyle =0
            LabelX =230
            LabelY =-30
            BorderThemeColorIndex =1
            BorderShade =65.0
            GridlineThemeColorIndex =1
            GridlineShade =65.0
        End
        Begin OptionGroup
            SpecialEffect =3
            BorderLineStyle =0
            Width =1701
            Height =1701
            BackThemeColorIndex =1
            BorderThemeColorIndex =1
            BorderShade =65.0
            GridlineThemeColorIndex =1
            GridlineShade =65.0
        End
        Begin BoundObjectFrame
            AddColon = NotDefault
            SizeMode =3
            SpecialEffect =2
            BorderLineStyle =0
            Width =4536
            Height =2835
            LabelX =-1701
            BackThemeColorIndex =1
            BorderThemeColorIndex =1
            BorderShade =65.0
            GridlineThemeColorIndex =1
            GridlineShade =65.0
        End
        Begin TextBox
            AddColon = NotDefault
            FELineBreak = NotDefault
            BorderLineStyle =0
            Width =1701
            LabelX =-1701
            FontSize =11
            FontName ="Calibri"
            AsianLineBreak =1
            BackThemeColorIndex =1
            BorderThemeColorIndex =1
            BorderShade =65.0
            ThemeFontIndex =1
            ForeThemeColorIndex =0
            ForeTint =75.0
            GridlineThemeColorIndex =1
            GridlineShade =65.0
        End
        Begin ListBox
            BorderLineStyle =0
            Width =1701
            Height =1417
            LabelX =-1701
            FontSize =11
            FontName ="Calibri"
            AllowValueListEdits =1
            InheritValueList =1
            ThemeFontIndex =1
            BackThemeColorIndex =1
            BorderThemeColorIndex =1
            BorderShade =65.0
            ForeThemeColorIndex =0
            ForeTint =75.0
            GridlineThemeColorIndex =1
            GridlineShade =65.0
        End
        Begin ComboBox
            AddColon = NotDefault
            BorderLineStyle =0
            Width =1701
            LabelX =-1701
            FontSize =11
            FontName ="Calibri"
            AllowValueListEdits =1
            InheritValueList =1
            ThemeFontIndex =1
            BackThemeColorIndex =1
            BorderThemeColorIndex =1
            BorderShade =65.0
            ForeThemeColorIndex =2
            ForeShade =50.0
            GridlineThemeColorIndex =1
            GridlineShade =65.0
        End
        Begin Subform
            BorderLineStyle =0
            Width =1701
            Height =1701
            BorderThemeColorIndex =1
            GridlineThemeColorIndex =1
            GridlineShade =65.0
            BorderShade =65.0
            ShowPageHeaderAndPageFooter =1
        End
        Begin UnboundObjectFrame
            SpecialEffect =2
            OldBorderStyle =1
            Width =4536
            Height =2835
            ThemeFontIndex =1
            BackThemeColorIndex =1
            BorderThemeColorIndex =1
            BorderShade =65.0
            ForeThemeColorIndex =2
            ForeShade =50.0
            GridlineThemeColorIndex =1
            GridlineShade =65.0
        End
        Begin PageBreak
            Width =283
        End
        Begin CustomControl
            OldBorderStyle =1
            Width =4536
            Height =2835
            BackThemeColorIndex =1
            BorderThemeColorIndex =1
            BorderShade =65.0
            GridlineThemeColorIndex =1
            GridlineShade =65.0
        End
        Begin Tab
            Width =5103
            Height =3402
            FontSize =11
            FontName ="Calibri"
            ThemeFontIndex =0
            GridlineThemeColorIndex =1
            GridlineShade =65.0
            UseTheme =1
            Shape =3
            BackThemeColorIndex =1
            BackShade =85.0
            BorderLineStyle =0
            BorderThemeColorIndex =2
            BorderTint =60.0
            HoverThemeColorIndex =1
            PressedThemeColorIndex =1
            HoverForeThemeColorIndex =0
            HoverForeTint =75.0
            PressedForeThemeColorIndex =0
            PressedForeTint =75.0
            ForeThemeColorIndex =0
            ForeTint =75.0
        End
        Begin Page
            Width =1701
            Height =1701
            BorderThemeColorIndex =1
            BorderShade =65.0
            GridlineThemeColorIndex =1
            GridlineShade =65.0
        End
        Begin EmptyCell
            Height =240
            GridlineThemeColorIndex =1
            GridlineShade =65.0
        End
        Begin NavigationControl
            BorderWidth =1
            BorderLineStyle =0
            BackThemeColorIndex =1
            BorderThemeColorIndex =1
            GridlineThemeColorIndex =1
            GridlineShade =65.0
        End
        Begin NavigationButton
            Width =283
            Height =283
            ForeColor =-2
            GridlineThemeColorIndex =1
            GridlineShade =65.0
            HoverColor =-2
            HoverThemeColorIndex =2
            HoverTint =20.0
            PressedColor =-2
            PressedThemeColorIndex =2
            PressedTint =60.0
            HoverForeColor =-2
            HoverForeThemeColorIndex =0
            HoverForeTint =75.0
            PressedForeColor =-2
            PressedForeThemeColorIndex =0
            PressedForeTint =75.0
            BackThemeColorIndex =1
            OldBorderStyle =0
            BorderLineStyle =0
            BorderThemeColorIndex =3
            BorderShade =90.0
            ThemeFontIndex =1
            FontName ="Calibri"
            FontWeight =400
            FontSize =11
            ForeThemeColorIndex =0
            ForeTint =75.0
        End
        Begin Section
            CanGrow = NotDefault
            CanShrink = NotDefault
            Height =585
            Name ="Detalle"
            AlternateBackThemeColorIndex =4
            AlternateBackTint =40.0
            BackThemeColorIndex =3
            Begin
                Begin TextBox
                    Locked = NotDefault
                    OldBorderStyle =0
                    OverlapFlags =93
                    TextFontCharSet =177
                    TextFontFamily =0
                    IMESentenceMode =3
                    Left =284
                    Top =284
                    Width =15
                    Height =15
                    FontSize =1
                    TabIndex =1
                    TopMargin =851
                    BackColor =-2147483603
                    BorderColor =10921638
                    ForeColor =4210752
                    Name ="HiddenControl"
                    FontName ="Calibri Light"
                    LeftPadding =0
                    TopPadding =0
                    RightPadding =0
                    BottomPadding =0
                    GridlineColor =10921638
                    ShowDatePicker =0

                    LayoutCachedLeft =284
                    LayoutCachedTop =284
                    LayoutCachedWidth =299
                    LayoutCachedHeight =299
                    BackThemeColorIndex =-1
                    ThemeFontIndex =-1
                End
                Begin TextBox
                    TabStop = NotDefault
                    EnterKeyBehavior = NotDefault
                    OverlapFlags =215
                    TextAlign =1
                    TextFontFamily =49
                    IMESentenceMode =3
                    Left =135
                    Top =120
                    Width =3175
                    Height =345
                    FontSize =10
                    FontWeight =100
                    LeftMargin =113
                    TopMargin =58
                    RightMargin =57
                    BorderColor =16777215
                    ForeColor =5855577
                    Name ="DS_JSON_EDITOR"
                    FontName ="72 Monospace"
                    OnLostFocus ="[Event Procedure]"
                    GroupTable =2
                    LeftPadding =15
                    TopPadding =15
                    RightPadding =15
                    BottomPadding =0
                    GridlineStyleLeft =1
                    GridlineStyleTop =1
                    GridlineStyleBottom =1
                    GridlineColor =10921638
                    TextFormat =1
                    VerticalAnchor =2
                    ShowDatePicker =0

                    LayoutCachedLeft =135
                    LayoutCachedTop =120
                    LayoutCachedWidth =3310
                    LayoutCachedHeight =465
                    ColumnEnd =1
                    LayoutGroup =1
                    BorderShade =100.0
                    ThemeFontIndex =-1
                    ForeTint =65.0
                    GroupTable =2
                    Begin
                        Begin Label
                            BackStyle =1
                            OldBorderStyle =1
                            OverlapFlags =93
                            TextFontCharSet =177
                            TextAlign =1
                            TextFontFamily =49
                            Left =3330
                            Top =120
                            Width =345
                            Height =345
                            FontSize =10
                            FontWeight =100
                            LeftMargin =113
                            TopMargin =58
                            RightMargin =57
                            ForeColor =5855577
                            Name ="Etiqueta1675"
                            FontName ="72 Monospace"
                            Tag ="DetailFormTitle"
                            ControlTipText ="OFERTA"
                            GroupTable =2
                            LeftPadding =0
                            TopPadding =15
                            RightPadding =15
                            BottomPadding =0
                            GridlineStyleTop =1
                            GridlineStyleRight =1
                            GridlineStyleBottom =1
                            GridlineColor =10921638
                            VerticalAnchor =2
                            LayoutCachedLeft =3330
                            LayoutCachedTop =120
                            LayoutCachedWidth =3675
                            LayoutCachedHeight =465
                            ColumnStart =2
                            ColumnEnd =2
                            LayoutGroup =1
                            ThemeFontIndex =-1
                            BorderThemeColorIndex =1
                            BorderTint =100.0
                            ForeTint =65.0
                            GroupTable =2
                        End
                    End
                End
                Begin CommandButton
                    TabStop = NotDefault
                    OverlapFlags =215
                    Left =3375
                    Top =135
                    Width =300
                    Height =316
                    FontWeight =100
                    TabIndex =2
                    ForeColor =5855577
                    Name ="DS_BUTTON_TOGGLE_EXPAND"
                    Caption ="◥"
                    FontName ="Segoe UI Symbol"
                    OnGotFocus ="[Event Procedure]"
                    ControlTipText ="Expand/Collapse"
                    GroupTable =3
                    LeftPadding =0
                    TopPadding =0
                    RightPadding =15
                    BottomPadding =15
                    GridlineColor =10921638
                    HorizontalAnchor =1

                    CursorOnHover =1
                    LayoutCachedLeft =3375
                    LayoutCachedTop =135
                    LayoutCachedWidth =3675
                    LayoutCachedHeight =451
                    LayoutGroup =2
                    ForeTint =65.0
                    Gradient =0
                    BackThemeColorIndex =1
                    BackTint =100.0
                    BorderThemeColorIndex =1
                    BorderTint =100.0
                    ThemeFontIndex =-1
                    HoverThemeColorIndex =1
                    HoverTint =100.0
                    PressedThemeColorIndex =1
                    PressedShade =100.0
                    HoverForeThemeColorIndex =8
                    HoverForeTint =100.0
                    HoverForeShade =75.0
                    PressedForeThemeColorIndex =7
                    PressedForeTint =100.0
                    GroupTable =3
                    Overlaps =1
                End
            End
        End
    End
End
CodeBehindForm
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = True
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Option Compare Database
Option Explicit

Private WithEvents pController As dsTaskController
Attribute pController.VB_VarHelpID = -1

Private pOriginalValue As String
Private pSequenceIndex As Long
Private pExpandedMode As Boolean


Property Get IsSubform() As Boolean
    On Error Resume Next
    IsSubform = Len(Me.Parent.Name) > 0
End Property

Public Property Get Controller() As dsTaskController
    Set Controller = pController
End Property

Public Property Set Controller(ByRef Value As dsTaskController)
    Set pController = Value
End Property

Public Property Get ExpandedMode() As Boolean: ExpandedMode = pExpandedMode: End Property
Public Property Let ExpandedMode(ByVal Value As Boolean): SetExpandedMode Value: End Property



Private Sub SetExpandedMode(ByVal Value As Boolean)
    If pExpandedMode <> Value Then
        pExpandedMode = Value
        ResizeToFit IIf(pExpandedMode, 6, 1)
        ' TODO: Propagate event to properly resize parent form/section
        'On Error Resume Next
        If Not IsSubform Then Exit Sub
        Me.Parent.ResizeFormHeaderToSize Me.Detalle.Height
    End If
End Sub

Private Sub ResizeToFit(ByVal NumLines As Long)
    Const vPadding As Long = 120
    Const lineHeight As Long = 345
    
    Me.DS_JSON_EDITOR.Height = NumLines * lineHeight
    Me.Detalle.Height = (2 * vPadding) + (NumLines * lineHeight)
    Me.DS_JSON_EDITOR.Height = NumLines * lineHeight
End Sub



Private Sub DS_BUTTON_TOGGLE_EXPAND_GotFocus()
    Me.HiddenControl.SetFocus
    ExpandedMode = Not ExpandedMode
    Debug.Print Printf("DS_JSON_EDITOR TOP: %1, HEIGHT: %2, DETALLE HEIGHT: %3", Me.DS_JSON_EDITOR.Top, Me.DS_JSON_EDITOR.Height, Me.Detalle.Height)
End Sub

Private Sub Form_KeyDown(KeyCode As Integer, Shift As Integer)
    On Error Resume Next
    If KeyCode = vbKeyReturn And Shift = 0 Then
        Debug.Print "[INFO] @DS_JSON_TASK_EDITOR.KeyDown(vbKeyReturn, 0)"
        KeyCode = 0
        Me.HiddenControl.SetFocus
        DoEvents
    End If
End Sub

Private Sub Form_Resize()
    Me.DS_JSON_EDITOR.HorizontalAnchor = acHorizontalAnchorBoth
    Me.DS_JSON_EDITOR.VerticalAnchor = acVerticalAnchorBoth
End Sub

Private Sub Form_Unload(Cancel As Integer)
    Debug.Print "[INFO] @DS_JSON_TASK_EDITOR.Unload()"
End Sub

Private Sub pController_OnActiveSequenceIndexChange(ByVal TargetIndex As Long)
    On Error GoTo Finally
    
    pSequenceIndex = TargetIndex    ' Controller.SequenceIndex
    pOriginalValue = Encode(JSON.Stringify(Controller.RebuildSequence(pSequenceIndex)))
    Me.DS_JSON_EDITOR = pOriginalValue
    SetGridlineAsValid Me.DS_JSON_EDITOR, True
    
    Exit Sub
Finally:
    Debug.Print "[UNHANDLED ERROR] @DS_JSON_TASK_EDITOR.pController_OnActiveSequenceIndexChange()"
    Resume Next
End Sub

Private Sub DS_JSON_EDITOR_LostFocus()
    ApplyChanges
End Sub

Private Sub ApplyChanges()
    Dim sValue As String, d As Scripting.Dictionary
    Debug.Print GetControlText(Me.DS_JSON_EDITOR)
    sValue = Decode(Application.PlainText(GetControlText(Me.DS_JSON_EDITOR)))
    If pOriginalValue <> "" And pOriginalValue <> sValue And Trim(sValue) <> "" Then
        Debug.Print sValue
        If TryParseJsonAsTask(sValue, d) Then
            SetGridlineAsValid Me.DS_JSON_EDITOR, True
            ReplaceTaskInRebuildSequence d, pSequenceIndex
        Else
            SetGridlineAsValid Me.DS_JSON_EDITOR, False
        End If
    End If
End Sub

Private Function TryParseJsonAsTask(ByVal JSONString As String, ByRef OutTask As Scripting.Dictionary) As Boolean
    On Error GoTo Finally
    
    Set OutTask = JSON.Parse(JSONString, True, True)
    TryParseJsonAsTask = True
Finally:
End Function

Private Sub ReplaceTaskInRebuildSequence(ByVal Task As Scripting.Dictionary, ByVal Index As Long)
    
    ' TODO: Simple task validation
    
    Controller.SetTask Task, Index
End Sub

Private Function Encode(ByVal JSONString As String) As String
    Dim s As String
    
    s = Replace(JSONString, """TaskName"":", "TaskName:")
    s = Replace(s, """Id"":", "Id:")
    s = Replace(s, """Values"":", "Values:")
    
    Encode = s
End Function

Private Function Decode(ByVal RenderedString As String) As String
    Dim s As String
    
    s = RenderedString
    
    Decode = s
End Function
